<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Residential Incentive Insights ‚Äì Interactive</title>
<style>
  :root{
    --bg:#0b0e12; --panel:#11161d; --muted:#8aa0b3;
    --text:#e8eef5; --accent:#7dd3fc; --accent2:#a3e635;
    --danger:#f87171; --good:#34d399; --warn:#fbbf24; --chip:#1b2531;
    --card:#0f141b; --border:#1e2a38; --focus:#60a5fa;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --panel:#ffffff; --muted:#64748b;
    --text:#0f172a; --accent:#0284c7; --accent2:#65a30d;
    --danger:#dc2626; --good:#16a34a; --warn:#ca8a04; --chip:#e2e8f0;
    --card:#ffffff; --border:#cbd5e1; --focus:#0ea5e9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial;transition:background-color .3s ease,color .3s ease}
  header{position:sticky;top:0;z-index:30;background:var(--panel);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,.1)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .header-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:16px;flex-wrap:wrap}
  .header-left{flex:1;min-width:280px}
  h1{font-size:20px;margin:0 0 6px 0}
  .sub{color:var(--muted);font-size:13px;line-height:1.5}
  .theme-toggle{cursor:pointer;background:var(--chip);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:10px;display:flex;align-items:center;gap:6px;font-size:13px;transition:all .2s;white-space:nowrap}
  .theme-toggle:hover{border-color:var(--focus);transform:scale(1.05)}
  .toolbar{display:grid;grid-template-columns:1fr;gap:14px;margin-top:12px}
  .filter-group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .filter-group label{color:var(--muted);font-size:12px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;min-width:120px}
  input[type="search"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);outline:none}
  input[type="search"]:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
  .multi-select{display:flex;flex-wrap:wrap;gap:8px;flex:1}
  .checkbox-item{display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--panel);transition:all .2s}
  .checkbox-item:hover{border-color:var(--focus);background:var(--chip)}
  .checkbox-item input[type="checkbox"]{cursor:pointer;width:16px;height:16px;accent-color:var(--accent)}
  .checkbox-item label{cursor:pointer;font-size:13px;color:var(--text);margin:0}
  .context-box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin:16px 0;box-shadow:0 2px 6px rgba(0,0,0,.1)}
  .context-box h2{margin:0 0 10px 0;font-size:17px;color:var(--accent);font-weight:600}
  .context-box p{margin:6px 0;line-height:1.7;color:var(--text)}
  .context-box ul{margin:10px 0;padding-left:24px;list-style:none}
  .context-box li{margin:6px 0;line-height:1.5;padding-left:20px;position:relative}
  .context-box li:before{content:"‚úì";position:absolute;left:0;color:var(--good);font-weight:bold}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin:16px auto}
  .card{grid-column:span 12;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.1);transition:box-shadow .2s}
  .card:hover{box-shadow:0 4px 12px rgba(0,0,0,.15)}
  @media (min-width:860px){.card{grid-column:span 6}}
  .card h3{margin:0 0 8px 0;font-size:16px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);margin-right:6px}
  .chip .dot{width:8px;height:8px;border-radius:50%}
  .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.danger{background:var(--danger)}
  .kv{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 10px 0}
  .kv .pill{background:var(--panel);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .aud-block{display:grid;grid-template-columns:1fr;gap:10px}
  .aud{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px}
  .aud h4{margin:0 0 8px 0;font-size:13px;letter-spacing:.2px;color:#cfd9e3}
  .aud ul{margin:0;padding-left:18px} .aud li{margin:4px 0}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{cursor:pointer;background:var(--chip);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;transition:all .2s}
  button:hover{border-color:var(--focus);background:var(--panel)}
  .footer{color:var(--muted);font-size:12px;margin:22px 0}
  .hide{display:none}
  .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip);color:var(--text)}
  .tag.green{background:#dcfce7;border-color:#16a34a;color:#166534}
  .tag.blue{background:#dbeafe;border-color:#0284c7;color:#075985}
  .tag.yellow{background:#fef9c3;border-color:#ca8a04;color:#854d0e}
  [data-theme="dark"] .tag.green{background:#052e2a;border-color:#065f46;color:#a7f3d0}
  [data-theme="dark"] .tag.blue{background:#06263a;border-color:#075985;color:#bae6fd}
  [data-theme="dark"] .tag.yellow{background:#2b1e07;border-color:#854d0e;color:#fde68a}
  .badge{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:#9fb6c8;background:#0d1520;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
  .sep{height:1px;background:var(--border);margin:10px 0}
  a{color:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="header-top">
      <div class="header-left">
        <h1>Residential Incentive Insights</h1>
        <div class="sub">Select project types and audiences to view tailored, data-driven guidance.</div>
      </div>
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
        <span id="themeIcon">‚òÄÔ∏è</span>
        <span id="themeLabel">Light</span>
      </button>
    </div>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Quick search (e.g., ductless, windows, CPF, SWR, audit)"/>
      
      <div class="filter-group">
        <label>Project Types:</label>
        <div class="multi-select" id="projectFilters"></div>
      </div>
      
      <div class="filter-group">
        <label>Audiences:</label>
        <div class="multi-select" id="audienceFilters"></div>
      </div>
    </div>
    <div class="row">
      <button id="btnCopy">Copy Visible Insights</button>
      <button id="btnExport">Export Visible JSON</button>
      <span id="msg" class="badge hide"></span>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="contextBox" class="context-box"></div>
  <div id="cards" class="grid"></div>
  <div class="footer">
    Built for quick, offline field use. Costs are typical ranges; always verify current specs and PI sheets before quoting.
  </div>
</main>

<script>
/** ---------- OVERVIEW CONTEXT ---------- **/
const OVERVIEW_CONTEXT = {
  default: {
    title: "Welcome to Residential Incentive Insights",
    content: `This interactive tool helps program managers, homeowners, and contractors navigate residential energy efficiency incentives. 
      Use the filters below to explore project types and view tailored guidance based on your role. Each project includes cost analysis, 
      implementation priorities, and stakeholder-specific action items.`
  },
  heat_pumps: {
    title: "Heat Pumps: The Electrification Leader",
    content: `Heat pumps are the cornerstone of residential electrification. They deliver 30‚Äì50% energy savings and work best when paired 
      with weatherization upgrades. CPF and SWR tiers make them accessible across income levels, while market-rate options respond to 
      financing and insulation bundles.`,
    keyPoints: ["Highest energy impact", "Multiple funding tiers available", "Best when bundled with insulation"]
  },
  insulation_and_envelope: {
    title: "Insulation & Envelope: The Foundation",
    content: `Dollar-for-dollar, insulation delivers the highest energy savings and is essential for heat pump performance. CPF and CERTA 
      funding remove barriers for income-qualified households. Target poorly insulated homes for maximum impact.`,
    keyPoints: ["Best ROI per dollar", "Prerequisite for HVAC efficiency", "CERTA unlocks stuck projects"]
  },
  controls_and_thermostats: {
    title: "Smart Controls: Small Investment, Big Returns",
    content: `Smart thermostats cost under $250 but deliver 8‚Äì15% energy savings. They're perfect bundled with heat pumps to prevent 
      inefficient auxiliary heat. Direct-install via CPF removes upfront barriers.`,
    keyPoints: ["Low cost, high payback", "Behavior change enabler", "Enhances HVAC performance"]
  },
  windows: {
    title: "Windows: Comfort Over Savings",
    content: `Window replacements offer significant comfort improvements but limited financial payback. Prioritize for health drivers 
      (condensation, noise) or in CPF projects where co-funding covers costs. Always bundle with air-sealing.`,
    keyPoints: ["High comfort impact", "Long payback period", "Best for equity-driven projects"]
  },
  gas_heating_systems: {
    title: "Gas Systems: Safety & Transition",
    content: `Gas furnaces remain relevant for safety upgrades and homes not ready for electrification. Focus on AFUE ‚â•95% and proper 
      venting. Fireplace incentives have questionable value and may warrant reprioritization.`,
    keyPoints: ["Mature technology", "Safety compliance focus", "Consider electrification alternatives"]
  },
  water_heating_systems: {
    title: "Water Heating: The Electrification Partner",
    content: `Heat pump water heaters align with decarbonization goals and save on operating costs. CPF can cover full costs for priority 
      households. Always verify electrical capacity and space requirements before installation.`,
    keyPoints: ["Supports electrification", "Moderate energy savings", "Best bundled with other upgrades"]
  },
  home_energy_assessment_and_certa: {
    title: "Assessments: Your Project Gateway",
    content: `Home energy assessments identify opportunities and prioritize multi-measure pathways. CERTA funding (up to $2,000) removes 
      repair barriers like outdated wiring or structural issues that block weatherization work.`,
    keyPoints: ["Identifies best opportunities", "Prioritizes multi-measure work", "CERTA enables stuck projects"]
  }
};

/** ---------- DATA (from your refined, practical JSON) ---------- **/
const DATA = {
  heat_pumps: {
    title: "Heat Pumps (ductless, ducted, extended-capacity)",
    summary: "High-impact electrification; strong savings; tiered incentives.",
    impact_tags: ["High impact","Electrification"],
    cost_and_incentive_ratio: {
      average_cost_usd: "2500‚Äì15000",
      standard_incentive_usd: 800,
      coverage_percent: "16‚Äì37%",
      swr_cpf_coverage_percent: "36‚Äì100%"
    },
    equity_and_market_leverage: [
      "CPF & no-cost tiers remove upfront barriers.",
      "Standard tier responds to financing + insulation bundles."
    ],
    implementation_priorities: [
      "HSPF2 ‚â• 8.1; correct sizing; aux heat lockout ‚â§ 35¬∞F.",
      "QA/QC via trade-ally network; target resistance or FA electric homes."
    ],
    stakeholder_value: {
      program_manager: [
        "Bundle with insulation to maximize realized savings.",
        "Track adoption; consider on-bill financing for market-rate."
      ],
      homeowner: [
        "Cuts heating/cooling bills 30‚Äì50%.",
        "SWR reduces cost; CPF can be no-cost."
      ],
      contractor: [
        "Pre-approval for CPF; load calcs + photos.",
        "Commissioning & homeowner maintenance guidance."
      ]
    }
  },

  gas_heating_systems: {
    title: "Gas Heating Systems (furnaces & fireplaces)",
    summary: "Mature measure; useful for safety/compliance; lower energy impact.",
    impact_tags: ["Moderate impact","Combustion"],
    cost_and_incentive_ratio: {
      furnace_cost_usd: "3000‚Äì7500",
      furnace_incentive_usd: "1600‚Äì2900",
      coverage_percent: "32‚Äì58%",
      fireplace_cost_usd: "2000‚Äì5000",
      fireplace_incentive_usd: "150‚Äì250"
    },
    equity_and_market_leverage: [
      "Higher rental incentives improve equity reach.",
      "Fireplace incentives have low energy value; consider deprioritization."
    ],
    implementation_priorities: [
      "AFUE ‚â• 95%; CO monitors; sealed combustion; proper venting.",
      "Coordinate gas utility eligibility."
    ],
    stakeholder_value: {
      program_manager: [
        "Focus funding on safety/rental stock; watch free-ridership.",
        "Shift fireplace funds to higher-savings measures if needed."
      ],
      homeowner: [
        "Reliable comfort; better for gas-dependent homes.",
        "Fireplaces are mostly aesthetic; long payback."
      ],
      contractor: [
        "Document AFUE, CO monitor, venting; code compliance.",
        "Provide commissioning reports to support rebates."
      ]
    }
  },

  water_heating_systems: {
    title: "Water Heating (heat-pump & tankless gas)",
    summary: "Moderate savings; best when bundled with electrification.",
    impact_tags: ["Medium impact","Hot water"],
    cost_and_incentive_ratio: {
      hpwh_cost_usd: "3600‚Äì6500",
      hpwh_incentive_usd: 240,
      tankless_cost_usd: "1200‚Äì3500",
      tankless_incentive_usd: 400
    },
    equity_and_market_leverage: [
      "CPF can fully fund HPWH in priority communities.",
      "HPWH aligns with decarbonization; tankless suits transition homes."
    ],
    implementation_priorities: [
      "Check electric capacity (30A), space, condensate for HPWH.",
      "Target end-of-life electric tanks; manage refrigerant + noise."
    ],
    stakeholder_value: {
      program_manager: [
        "Bundle HPWH with heat pump or panel upgrades for scale.",
        "Use CPF to overcome upfront barriers."
      ],
      homeowner: [
        "Lower operating cost; quiet, efficient.",
        "CPF may eliminate upfront cost."
      ],
      contractor: [
        "Pre-site checks (power, drain, airflow).",
        "Customer orientation on temp/filters."
      ]
    }
  },

  insulation_and_envelope: {
    title: "Insulation & Envelope (attic, wall, floor)",
    summary: "Highest $/savings; prerequisite for heat-pump performance.",
    impact_tags: ["Very high impact","Weatherization"],
    cost_and_incentive_ratio: {
      average_cost_per_sqft_usd: "1.0‚Äì4.5",
      standard_coverage: "50‚Äì60%",
      swr_cpf_coverage: "60‚Äì120%",
      certa_fund_usd: 2000
    },
    equity_and_market_leverage: [
      "CPF + CERTA remove structural barriers (wiring, rot, moisture).",
      "Link with health/IAQ funding to widen access."
    ],
    implementation_priorities: [
      "Audit R-values; insulate to R-38 attic, R-30 floor (SF), R-22 (MH).",
      "Add air-sealing, ventilation; photo & sqft documentation."
    ],
    stakeholder_value: {
      program_manager: [
        "Target worst-insulated homes for highest returns.",
        "Use CERTA to unlock 'stuck' projects."
      ],
      homeowner: [
        "Comfort year-round; big bill savings; often $0 under CPF.",
        "SWR typically halves out-of-pocket cost."
      ],
      contractor: [
        "Address rim joists & knee walls; vapor details matter.",
        "Follow CERTA workflow for enabling repairs."
      ]
    }
  },

  windows: {
    title: "Windows",
    summary: "High comfort; low financial payback; equity-driven use case.",
    impact_tags: ["Comfort","Low energy ROI"],
    cost_and_incentive_ratio: {
      avg_window_cost_usd: 600,
      incentive_per_sqft_usd: "1.0‚Äì1.5",
      coverage_percent: "2‚Äì3%"
    },
    equity_and_market_leverage: [
      "CPF enhanced windows may cover full cost with co-funding.",
      "Prioritize single-pane / metal-framed double-pane homes."
    ],
    implementation_priorities: [
      "Verify U-value tiers (‚â§0.22 or 0.23‚Äì0.27).",
      "Bundle with air-sealing; ensure flashing & drainage plane."
    ],
    stakeholder_value: {
      program_manager: [
        "Use selectively for health/condensation, noise, or safety drivers.",
        "Favor CPF projects where co-funding exists."
      ],
      homeowner: [
        "Major comfort upgrade; less bill impact unless replacing single-pane.",
        "CPF may enable no-cost installs."
      ],
      contractor: [
        "U-factor documentation; measure conditions correctly.",
        "Educate on ventilation to manage condensation."
      ]
    }
  },

  controls_and_thermostats: {
    title: "Controls & Thermostats",
    summary: "Low-cost, high-payback; boosts HVAC performance.",
    impact_tags: ["High ROI","Behavior + control"],
    cost_and_incentive_ratio: {
      device_cost_usd: "113‚Äì239",
      incentive_usd: 250,
      coverage_percent: "‚âà100%"
    },
    equity_and_market_leverage: [
      "CPF direct-install enables instant comfort and savings.",
      "Pair with heat pumps to curb auxiliary heat."
    ],
    implementation_priorities: [
      "Maintain approved model list & compatibility matrix.",
      "Set heat-pump lockout ‚â§ 35¬∞F; verify Wi-Fi/app setup."
    ],
    stakeholder_value: {
      program_manager: [
        "Great uptake driver; keep funded as a bundle.",
        "Track persistence with follow-up nudges."
      ],
      homeowner: [
        "8‚Äì15% energy reduction; better comfort & control.",
        "Often free after incentive."
      ],
      contractor: [
        "Fast install; strong add-on to HVAC quotes.",
        "Provide brief training for satisfaction."
      ]
    }
  },

  home_energy_assessment_and_certa: {
    title: "Home Energy Assessment & CERTA",
    summary: "Gateway service; aligns projects and funding.",
    impact_tags: ["Enablement","Pipeline"],
    cost_and_incentive_ratio: {
      audit_cost_usd: "439‚Äì615",
      rebate_usd: "250‚Äì500",
      coverage_percent: "50‚Äì100%",
      certa_funding_usd: 2000
    },
    equity_and_market_leverage: [
      "CERTA removes repair barriers (e.g., wiring, rot).",
      "Full audit coverage for CPF/multifamily expands equity."
    ],
    implementation_priorities: [
      "Standardize report & digital submission.",
      "Integrate with project tracking & referrals."
    ],
    stakeholder_value: {
      program_manager: [
        "Use audits to prioritize multi-measure pathways.",
        "Coordinate cross-funders for stackable support."
      ],
      homeowner: [
        "Clear roadmap of upgrades & rebates.",
        "Repairs covered via CERTA can 'unlock' insulation."
      ],
      contractor: [
        "Certified only; ensure complete data capture.",
        "Plan multifamily logistics and documentation."
      ]
    }
  }
};

/** ---------- UTILITIES ---------- **/
const byKey = (obj, key) => obj[key];
const fmtMoney = v => (typeof v === "number" ? `$${v.toLocaleString()}` : v);
const html = (strings, ...vals) => strings.map((s,i)=>s+(vals[i]??"")).join("");

const PROJECT_OPTIONS = Object.entries(DATA).map(([k,v])=>({value:k,label:v.title}));
const AUDIENCE_OPTIONS = [
  {value:"program_manager",label:"Program Manager"},
  {value:"homeowner",label:"Homeowner"},
  {value:"contractor",label:"Contractor"}
];

/** ---------- STATE ---------- **/
let selectedProjects = new Set();
let selectedAudiences = new Set(["program_manager","homeowner","contractor"]);
let currentTheme = localStorage.getItem("theme") || "dark";

/** ---------- ELEMENTS ---------- **/
const cardsEl = document.getElementById("cards");
const qEl = document.getElementById("q");
const msgEl = document.getElementById("msg");
const contextBoxEl = document.getElementById("contextBox");
const themeToggleBtn = document.getElementById("themeToggle");
const themeIconEl = document.getElementById("themeIcon");
const themeLabelEl = document.getElementById("themeLabel");

/** ---------- THEME ---------- **/
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  currentTheme = theme;
  localStorage.setItem("theme", theme);
  if(theme==="light"){
    themeIconEl.textContent = "üåô";
    themeLabelEl.textContent = "Dark";
  } else {
    themeIconEl.textContent = "‚òÄÔ∏è";
    themeLabelEl.textContent = "Light";
  }
}

function toggleTheme(){
  applyTheme(currentTheme==="dark" ? "light" : "dark");
}

/** ---------- CONTEXT BOX ---------- **/
function renderContext(){
  if(selectedProjects.size === 0){
    const ctx = OVERVIEW_CONTEXT.default;
    contextBoxEl.innerHTML = `
      <h2>${ctx.title}</h2>
      <p>${ctx.content}</p>
    `;
    contextBoxEl.style.display = "block";
  } else if(selectedProjects.size === 1){
    const key = Array.from(selectedProjects)[0];
    const ctx = OVERVIEW_CONTEXT[key] || OVERVIEW_CONTEXT.default;
    const points = ctx.keyPoints ? `<ul>${ctx.keyPoints.map(p=>`<li>${p}</li>`).join("")}</ul>` : "";
    contextBoxEl.innerHTML = `
      <h2>${ctx.title}</h2>
      <p>${ctx.content}</p>
      ${points}
    `;
    contextBoxEl.style.display = "block";
  } else {
    contextBoxEl.style.display = "none";
  }
}

/** ---------- INIT FILTERS ---------- **/
function initFilters(){
  const projectFiltersEl = document.getElementById("projectFilters");
  const audienceFiltersEl = document.getElementById("audienceFilters");
  
  // Project checkboxes
  PROJECT_OPTIONS.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "checkbox-item";
    const id = `proj_${opt.value}`;
    div.innerHTML = `<input type="checkbox" id="${id}" value="${opt.value}"/><label for="${id}">${opt.label}</label>`;
    projectFiltersEl.appendChild(div);
    const cb = div.querySelector("input");
    cb.addEventListener("change", ()=>{
      if(cb.checked) selectedProjects.add(opt.value);
      else selectedProjects.delete(opt.value);
      renderAll();
    });
  });
  
  // Audience checkboxes
  AUDIENCE_OPTIONS.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "checkbox-item";
    const id = `aud_${opt.value}`;
    div.innerHTML = `<input type="checkbox" id="${id}" value="${opt.value}" checked/><label for="${id}">${opt.label}</label>`;
    audienceFiltersEl.appendChild(div);
    const cb = div.querySelector("input");
    cb.addEventListener("change", ()=>{
      if(cb.checked) selectedAudiences.add(opt.value);
      else selectedAudiences.delete(opt.value);
      renderAll();
    });
  });
}

function badgeDots(key){
  const map = {
    "High impact":"good","Very high impact":"good","High ROI":"good",
    "Comfort":"warn","Low energy ROI":"warn","Combustion":"danger"
  };
  return map[key]||"warn";
}

function renderCards(){
  const query = qEl.value.trim().toLowerCase();

  // build list
  let items = Object.entries(DATA).map(([k,v])=>({key:k, ...v}));

  // filter by selected projects
  if(selectedProjects.size > 0){
    items = items.filter(i=>selectedProjects.has(i.key));
  }

  // search query across title, summary, tags and audience text
  if(query){
    items = items.filter(i=>{
      const hay = [
        i.title, i.summary, ...(i.impact_tags||[]),
        ...(i.equity_and_market_leverage||[]),
        ...(i.implementation_priorities||[]),
        ...((i.stakeholder_value?.program_manager)||[]),
        ...((i.stakeholder_value?.homeowner)||[]),
        ...((i.stakeholder_value?.contractor)||[])
      ].join(" ").toLowerCase();
      return hay.includes(query);
    });
  }

  cardsEl.innerHTML = "";

  items.forEach(item=>{
    const {title, summary, impact_tags=[], cost_and_incentive_ratio={}, equity_and_market_leverage=[], implementation_priorities=[]} = item;

    const costPills = Object.entries(cost_and_incentive_ratio).map(([k,v])=>{
      const label = k.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase());
      return `<span class="pill" title="${label}">${label}: ${typeof v==='object'?JSON.stringify(v):fmtMoney(v)}</span>`;
    }).join("");

    const tags = impact_tags.map(t=>`<span class="chip"><span class="dot ${badgeDots(t)}"></span>${t}</span>`).join("");

    // audience blocks
    const showPM = selectedAudiences.has("program_manager");
    const showHO = selectedAudiences.has("homeowner");
    const showCT = selectedAudiences.has("contractor");

    const pm = (item.stakeholder_value?.program_manager||[]).map(li=>`<li>${li}</li>`).join("") || "<li class='muted'>No items</li>";
    const ho = (item.stakeholder_value?.homeowner||[]).map(li=>`<li>${li}</li>`).join("") || "<li class='muted'>No items</li>";
    const ct = (item.stakeholder_value?.contractor||[]).map(li=>`<li>${li}</li>`).join("") || "<li class='muted'>No items</li>";

    const eq = (equity_and_market_leverage||[]).map(x=>`<span class="tag green">${x}</span>`).join("");
    const impl = (implementation_priorities||[]).map(x=>`<span class="tag blue">${x}</span>`).join("");

    const card = document.createElement("section");
    card.className = "card";
    card.dataset.key = item.key;

    card.innerHTML = html`
      <h3>${title}</h3>
      <div class="muted">${summary}</div>
      <div class="row" style="margin-top:8px">${tags}</div>

      <div class="kv">${costPills}</div>

      <div class="row">${eq}</div>
      <div style="height:6px"></div>
      <div class="row">${impl}</div>

      <div class="sep"></div>

      <div class="aud-block">
        ${showPM ? `<div class="aud"><h4>Program Manager</h4><ul>${pm}</ul></div>` : ``}
        ${showHO ? `<div class="aud"><h4>Homeowner</h4><ul>${ho}</ul></div>` : ``}
        ${showCT ? `<div class="aud"><h4>Contractor</h4><ul>${ct}</ul></div>` : ``}
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btnCopyCard">Copy Card</button>
        <button class="btnJson">View JSON</button>
      </div>
    `;

    // button handlers
    card.querySelector(".btnCopyCard").onclick = ()=>{
      const text = card.innerText.replace(/\n{2,}/g,"\n").trim();
      navigator.clipboard.writeText(text);
      flash("Copied card text");
    };
    card.querySelector(".btnJson").onclick = ()=>{
      const pretty = JSON.stringify(DATA[item.key], null, 2);
      const blob = new Blob([pretty], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `${item.key}.json`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    };

    cardsEl.appendChild(card);
  });

  if(items.length===0){
    const empty = document.createElement("div");
    empty.className="card";
    empty.innerHTML = `<div class="muted">No results. Try selecting different filters or using broader keywords.</div>`;
    cardsEl.appendChild(empty);
  }
}

function renderAll(){
  renderContext();
  renderCards();
}

function flash(text){
  msgEl.textContent = text;
  msgEl.classList.remove("hide");
  setTimeout(()=>msgEl.classList.add("hide"), 1800);
}

function exportVisibleJSON(){
  const q = qEl.value.trim().toLowerCase();
  let items = Object.entries(DATA).map(([k,v])=>({k,v}));
  
  if(selectedProjects.size > 0){
    items = items.filter(({k})=>selectedProjects.has(k));
  }
  
  if(q){
    items = items.filter(({v})=>{
      const hay = [
        v.title, v.summary, ...(v.impact_tags||[]),
        ...(v.equity_and_market_leverage||[]),
        ...(v.implementation_priorities||[]),
        ...((v.stakeholder_value?.program_manager)||[]),
        ...((v.stakeholder_value?.homeowner)||[]),
        ...((v.stakeholder_value?.contractor)||[])
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }
  
  // Filter by selected audiences
  const pruned = {};
  items.forEach(({k,v})=>{
    const copy = JSON.parse(JSON.stringify(v));
    if(selectedAudiences.size < 3){
      const filteredValue = {};
      selectedAudiences.forEach(aud => {
        filteredValue[aud] = v.stakeholder_value?.[aud] || [];
      });
      copy.stakeholder_value = filteredValue;
    }
    pruned[k]=copy;
  });
  
  const blob = new Blob([JSON.stringify(pruned,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="visible_insights.json"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1500);
  flash("Exported JSON");
}

// Button listeners
document.getElementById("btnCopy").onclick = ()=>{
  const t = Array.from(document.querySelectorAll(".card")).map(c=>c.innerText).join("\n\n---\n\n");
  navigator.clipboard.writeText(t); flash("Copied visible insights");
};
document.getElementById("btnExport").onclick = exportVisibleJSON;
themeToggleBtn.onclick = toggleTheme;

qEl.addEventListener("input", renderCards);

// init
applyTheme(currentTheme);
initFilters();
renderAll();
</script>
</body>
</html>
