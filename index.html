<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Residential Incentive Insights – Oregon Energy Efficiency Programs</title>
<meta name="description" content="Unofficial guide to Oregon energy efficiency incentive programs including Energy Trust (Savings Within Reach, Community Partner Funding), CERTA, and federal HOMES/HEAR rebates. Compare costs, incentives, and eligibility." />
<meta name="keywords" content="Oregon energy efficiency, Energy Trust Oregon, Savings Within Reach, SWR, Community Partner Funding, CPF, CERTA, HOMES rebate, HEAR rebate, heat pump incentives, insulation rebates" />
<meta name="author" content="Oregon Energy Efficiency Resources" />
<meta name="robots" content="index, follow" />
<link rel="canonical" href="https://kamrawr.github.io/residential-incentive-insights/" />

<!-- Open Graph / Social Media -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https://kamrawr.github.io/residential-incentive-insights/" />
<meta property="og:title" content="Oregon Residential Energy Incentive Guide" />
<meta property="og:description" content="Explore Oregon energy efficiency programs: Energy Trust, CERTA, and federal IRA rebates for heat pumps, insulation, and more." />
<meta property="og:site_name" content="Residential Incentive Insights" />

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Oregon Residential Energy Incentive Guide" />
<meta name="twitter:description" content="Unofficial guide to Oregon energy efficiency incentive programs and rebates." />
<style>
  :root{
    --bg:#0b0e12; --panel:#11161d; --muted:#8aa0b3;
    --text:#e8eef5; --accent:#7dd3fc; --accent2:#a3e635;
    --danger:#f87171; --good:#34d399; --warn:#fbbf24; --chip:#1b2531;
    --card:#0f141b; --border:#1e2a38; --focus:#60a5fa;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --panel:#ffffff; --muted:#64748b;
    --text:#0f172a; --accent:#0284c7; --accent2:#65a30d;
    --danger:#dc2626; --good:#16a34a; --warn:#ca8a04; --chip:#e2e8f0;
    --card:#ffffff; --border:#cbd5e1; --focus:#0ea5e9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial;transition:background-color .3s ease,color .3s ease}
  header{position:sticky;top:0;z-index:30;background:var(--panel);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,.1);transition:all .3s ease}
  header.collapsed .toolbar{max-height:0;overflow:hidden;opacity:0;margin:0;padding:0}
  header.collapsed .header-top{margin-bottom:0}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .header-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:16px;flex-wrap:wrap;transition:margin .3s ease}
  .header-left{flex:1;min-width:280px}
  h1{font-size:20px;margin:0 0 6px 0;cursor:pointer;user-select:none;display:flex;align-items:center;gap:8px}
  h1:hover{color:var(--accent)}
  .collapse-icon{font-size:16px;transition:transform .3s ease}
  header.collapsed .collapse-icon{transform:rotate(180deg)}
  .sub{color:var(--muted);font-size:13px;line-height:1.5}
  .theme-toggle{cursor:pointer;background:var(--chip);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:10px;display:flex;align-items:center;gap:6px;font-size:13px;transition:all .2s;white-space:nowrap}
  .theme-toggle:hover{border-color:var(--focus);transform:scale(1.05)}
  .toolbar{display:grid;grid-template-columns:1fr;gap:14px;margin-top:12px;transition:all .3s ease;max-height:500px;overflow:visible}
  .filter-group{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .filter-group label{color:var(--muted);font-size:12px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;min-width:120px}
  input[type="search"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);outline:none}
  input[type="search"]:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
  .multi-select{display:flex;flex-wrap:wrap;gap:8px;flex:1}
  .checkbox-item{display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--panel);transition:all .2s}
  .checkbox-item:hover{border-color:var(--focus);background:var(--chip)}
  .checkbox-item input[type="checkbox"]{cursor:pointer;width:16px;height:16px;accent-color:var(--accent)}
  .checkbox-item label{cursor:pointer;font-size:13px;color:var(--text);margin:0}
  .filter-summary{display:none;font-size:12px;color:var(--muted);margin-top:4px}
  header.collapsed .filter-summary{display:block}
  .context-box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin:16px 0;box-shadow:0 2px 6px rgba(0,0,0,.1)}
  .context-box h2{margin:0 0 10px 0;font-size:17px;color:var(--accent);font-weight:600}
  .context-box p{margin:6px 0;line-height:1.7;color:var(--text)}
  .context-box ul{margin:10px 0;padding-left:24px;list-style:none}
  .context-box li{margin:6px 0;line-height:1.5;padding-left:20px;position:relative}
  .context-box li:before{content:"✓";position:absolute;left:0;color:var(--good);font-weight:bold}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin:16px auto}
  .card{grid-column:span 12;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.1);transition:box-shadow .2s}
  .card:hover{box-shadow:0 4px 12px rgba(0,0,0,.15)}
  @media (min-width:860px){.card{grid-column:span 6}}
  .card h3{margin:0 0 8px 0;font-size:16px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);margin-right:6px}
  .chip .dot{width:8px;height:8px;border-radius:50%}
  .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.danger{background:var(--danger)}
  .kv{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 10px 0}
  .kv .pill{background:var(--panel);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .aud-block{display:grid;grid-template-columns:1fr;gap:10px}
  .aud{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px}
  .aud h4{margin:0 0 8px 0;font-size:13px;letter-spacing:.2px;color:#cfd9e3}
  .aud ul{margin:0;padding-left:18px} .aud li{margin:4px 0}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{cursor:pointer;background:var(--chip);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;transition:all .2s}
  button:hover{border-color:var(--focus);background:var(--panel)}
  .footer{color:var(--muted);font-size:12px;margin:22px 0}
  .disclaimer{background:var(--panel);border-left:3px solid var(--warn);padding:14px;margin:16px 0;border-radius:8px;font-size:13px;line-height:1.6}
  .disclaimer strong{color:var(--warn)}
  .hide{display:none}
  .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip);color:var(--text)}
  .tag.green{background:#dcfce7;border-color:#16a34a;color:#166534}
  .tag.blue{background:#dbeafe;border-color:#0284c7;color:#075985}
  .tag.yellow{background:#fef9c3;border-color:#ca8a04;color:#854d0e}
  [data-theme="dark"] .tag.green{background:#052e2a;border-color:#065f46;color:#a7f3d0}
  [data-theme="dark"] .tag.blue{background:#06263a;border-color:#075985;color:#bae6fd}
  [data-theme="dark"] .tag.yellow{background:#2b1e07;border-color:#854d0e;color:#fde68a}
  .badge{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:#9fb6c8;background:#0d1520;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
  .sep{height:1px;background:var(--border);margin:10px 0}
  a{color:var(--accent)}
  .tooltip{position:relative;display:inline-block;border-bottom:1px dotted var(--accent);cursor:help}
  .tooltip .tooltiptext{visibility:hidden;width:320px;background:var(--panel);color:var(--text);text-align:left;border-radius:8px;padding:12px;position:absolute;z-index:100;bottom:125%;left:50%;margin-left:-160px;opacity:0;transition:opacity .3s;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,.3);font-size:12px;line-height:1.5}
  .tooltip .tooltiptext strong{display:block;margin-bottom:6px;color:var(--accent);font-size:13px}
  .tooltip:hover .tooltiptext{visibility:visible;opacity:1}
  .tooltip .tooltiptext::after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:var(--border) transparent transparent transparent}
  .program-info{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
  .program-info h3{margin:0 0 8px 0;font-size:14px;color:var(--accent2)}
  .program-info p{margin:6px 0;font-size:13px;line-height:1.6}
  .program-info .income-box{background:var(--chip);border:1px solid var(--border);border-radius:8px;padding:10px;margin-top:8px}
  .program-info .income-box strong{color:var(--good);display:block;margin-bottom:4px}
</style>
</head>
<body>
<a href="#main-content" class="skip-link" style="position:absolute;left:-9999px;z-index:999;padding:1em;background:var(--accent);color:var(--bg);text-decoration:none;font-weight:bold;">Skip to main content</a>
<header role="banner">
  <div class="wrap">
    <div class="header-top">
      <div class="header-left">
        <h1 id="headerTitle" role="button" tabindex="0" aria-expanded="true" aria-controls="toolbar">
          <span>Residential Incentive Insights</span>
          <span class="collapse-icon" aria-hidden="true">▼</span>
        </h1>
        <div class="sub">Explore energy efficiency incentive programs including <span class="tooltip">SWR<span class="tooltiptext"><strong>Savings Within Reach (SWR)</strong>Energy Trust of Oregon program providing increased incentives and financing options to help moderate-income households afford energy-saving home upgrades. Offers higher cash incentives and optional On-Bill Repayment financing.</span></span>, <span class="tooltip">CPF<span class="tooltiptext"><strong>Community Partner Funding (CPF)</strong>Energy Trust of Oregon program providing higher incentives to community-based organizations serving communities of color, rural areas, and low-income households. Partners help residents access energy-saving upgrades like weatherization and efficient heating/cooling systems.</span></span>, <span class="tooltip">CERTA<span class="tooltiptext"><strong>Climate Equity and Resilience Through Action (CERTA)</strong>Oregon program using EPA grant funding for greenhouse gas emission reduction initiatives. Provides benefits like energy efficiency improvements, EV incentives, and support for low-income communities through projects in buildings, transportation, and waste management.</span></span>, and <span class="tooltip">HOMES/HEAR<span class="tooltiptext"><strong>Federal IRA Rebate Programs</strong>HOMES (Home Efficiency Rebates): rebates for energy-efficient retrofits like insulation, air sealing, and windows. HEAR (Home Electrification and Appliance Rebates): point-of-sale rebates for high-efficiency electric appliances like heat pumps, primarily for households ≤150% area median income.</span></span>.</div>
        <div class="filter-summary" id="filterSummary"></div>
      </div>
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
        <span id="themeIcon">☀️</span>
        <span id="themeLabel">Light</span>
      </button>
    </div>
    <div class="toolbar" id="toolbar">
      <label for="q" class="sr-only" style="position:absolute;left:-9999px;">Search projects and programs</label>
      <input id="q" type="search" placeholder="Quick search (e.g., ductless, windows, CPF, SWR, CERTA, HOMES, HEAR)" aria-label="Search projects and programs"/>

      <div class="filter-group">
        <label id="projectTypesLabel">Project Types:</label>
        <div class="multi-select" id="projectFilters" role="group" aria-labelledby="projectTypesLabel"></div>
      </div>

      <div class="filter-group">
        <label id="audiencesLabel">Audiences:</label>
        <div class="multi-select" id="audienceFilters" role="group" aria-labelledby="audiencesLabel"></div>
      </div>
    </div>
    <div class="row">
      <button id="btnCopy" aria-label="Copy all visible project insights to clipboard">Copy Visible Insights</button>
      <button id="btnExport" aria-label="Export visible project data as JSON file">Export Visible JSON</button>
      <span id="msg" class="badge hide" role="status" aria-live="polite"></span>
    </div>
  </div>
</header>

<main class="wrap" id="main-content" role="main">
  <div class="disclaimer">
    <strong>⚠️ IMPORTANT DISCLAIMER:</strong> This is an <strong>unofficial, informational tool only</strong> and does not represent official guidance, recommendations, or endorsements from Energy Trust of Oregon, any government agency, or program administrator. All program data is compiled from publicly available sources and may be outdated, incomplete, or subject to change without notice.
    <br><br>
    <strong>Before making any financial decisions or purchases:</strong>
    <ul style="margin:8px 0 0 20px;padding:0;">
      <li>Verify all current program requirements, eligibility criteria, and incentive amounts directly with official program administrators</li>
      <li>Confirm income qualifications and available funding with Energy Trust of Oregon and federal program representatives</li>
      <li>Consult with qualified professionals and obtain multiple quotes before committing to any projects</li>
      <li>Review official program documentation and application requirements</li>
    </ul>
    <strong>This tool is provided "as-is" without warranties of any kind.</strong> The author assumes no liability for decisions made based on this information.
  </div>

  <div class="program-info">
    <h3>📋 Program Overview & Income Qualifications (Unofficial Summary - Verify Before Applying)</h3>
    <p><strong>Standard Incentives:</strong> Typically available to all qualifying households regardless of income. Partial cost coverage (approximately 15-60% depending on measure). <em>Verify current eligibility and amounts.</em></p>

    <p style="background:var(--chip);border:1px solid var(--border);border-radius:8px;padding:10px;margin:10px 0;">
      💡 <strong>Check Your Eligibility:</strong> Use the <a href="https://kamrawr.github.io/oregon-income-calculator/" target="_blank" style="color:var(--accent);font-weight:600;">Oregon Income Eligibility Calculator</a> to determine which program tier you may qualify for based on your household income and county.
    </p>

    <div class="income-box">
      <strong>Savings Within Reach (SWR) - Approximate Eligibility:</strong>
      Energy Trust of Oregon program for moderate-income households, generally earning 60-80% of Area Median Income (AMI). For a family of 4 in Oregon, this may be approximately $55,000-$73,000 annually (varies significantly by county and household size). Provides increased cash incentives for energy upgrades and optional On-Bill Repayment financing through utility bills. <em><strong>Verify current income limits, incentive amounts, and financing options with Energy Trust of Oregon before applying.</strong></em>
    </div>

    <div class="income-box">
      <strong>Community Partner Funding (CPF) - Approximate Eligibility:</strong>
      Energy Trust of Oregon program providing enhanced incentives through community-based organizations serving communities of color, rural areas, and low-income households (typically ≤60% AMI). For a family of 4 in Oregon, this may be approximately $55,000 or less annually (varies by county and household size). Community partners help residents access energy-saving upgrades like weatherization and efficient heating/cooling systems. <em><strong>Verify current income limits and available community partners with Energy Trust of Oregon before applying.</strong></em>
    </div>

    <div class="income-box">
      <strong>Climate Equity and Resilience Through Action (CERTA):</strong>
      Oregon program funded by a $197 million EPA grant to reduce greenhouse gas emissions. Works with state agencies to implement projects in buildings, transportation, and waste management. Provides energy efficiency improvements, electric vehicle incentives, and support for low-income communities. May include funding for barriers like outdated electrical, structural repairs, or moisture issues that prevent energy upgrades. <em><strong>Verify current program availability, eligible projects, and application process with Oregon state agencies.</strong></em>
    </div>

    <div class="income-box">
      <strong>HOMES (Home Efficiency Rebates - Federal IRA Program - Approximate Information):</strong>
      Part of the Inflation Reduction Act (IRA) providing rebates for energy-efficient retrofits including insulation, air sealing, and energy-efficient windows. Available to both homeowners and renters; higher rebates for low-income households. Rebates may range from $2,000-$8,000 based on energy savings achieved. May require home energy audit. <em><strong>Verify current federal program status, Oregon state implementation, eligibility, and requirements before planning projects.</strong></em>
    </div>

    <div class="income-box">
      <strong>HEAR (Home Electrification and Appliance Rebates - Federal IRA - Approximate Information):</strong>
      Part of the Inflation Reduction Act (IRA) providing point-of-sale rebates for high-efficiency electric appliances, primarily for low-to-moderate-income households (typically ≤150% area median income). May cover heat pumps, heat pump water heaters, and related upgrades like insulation and electrical panel improvements. Rebates can cover a significant portion of project costs. <em><strong>Verify current federal program status, Oregon state implementation, and exact rebate amounts before purchasing.</strong></em>
    </div>

    <p style="margin-top:10px;font-size:12px;color:var(--muted);">
      <em><strong>⚠️ All figures above are approximate and subject to change.</strong> Income limits vary significantly by county, household size, and program year. Federal HOMES/HEAR programs may not yet be fully implemented in all states. <strong>Always contact official program administrators</strong> or visit <a href="https://www.energytrust.org" target="_blank">energytrust.org</a> (for Energy Trust programs) or your state energy office (for federal programs) to verify current eligibility, amounts, and timelines before making any financial commitments.</em>
    </p>
  </div>

  <div id="contextBox" class="context-box" role="complementary" aria-label="Project context information"></div>
  <div id="recommendations" class="context-box" role="complementary" aria-label="Recommendations" style="display:none;border-left:3px solid var(--accent2);"></div>
  <div id="cards" class="grid" role="region" aria-label="Project details"></div>
  <footer class="footer" role="contentinfo">
    <strong>⚠️ REMINDER:</strong> This unofficial tool provides approximate guidance only. All costs, incentive amounts, and program details are subject to change. <strong>Never make significant financial purchases or commitments based solely on this information.</strong> Always verify current specifications, eligibility requirements, and incentive amounts with official program administrators and obtain professional quotes before proceeding. Data compiled from publicly available sources; accuracy not guaranteed.
  </footer>
</main>

<script>
/** ---------- OVERVIEW CONTEXT ---------- **/
const OVERVIEW_CONTEXT = {
  default: {
    title: "Welcome to Residential Incentive Insights (Unofficial Reference Tool)",
    content: `This unofficial reference tool provides general information about residential energy efficiency incentive programs, including
      Energy Trust of Oregon programs (Standard, Savings Within Reach, Community Partner Funding), Oregon CERTA program, and federal HOMES/HEAR
      rebates compiled from publicly available sources. Use the filters below to explore project types and view approximate guidance.
      <strong>All information is subject to change and must be verified with official program administrators before making any financial
      decisions.</strong> This tool does not constitute professional advice or official program guidance.`
  },
  heat_pumps: {
    title: "Heat Pumps: The Electrification Leader",
    content: `Heat pumps are the cornerstone of residential electrification. They deliver 30–50% energy savings and work best when paired
      with weatherization upgrades. Community Partner Funding and Savings Within Reach make them accessible across income levels, while
      federal HEAR rebates add up to $8,000 additional funding. Market-rate options respond to financing and insulation bundles.`,
    keyPoints: ["Highest energy impact", "Multiple funding tiers (Energy Trust + HEAR)", "Best when bundled with insulation"]
  },
  insulation_and_envelope: {
    title: "Insulation & Envelope: The Foundation",
    content: `Dollar-for-dollar, insulation delivers the highest energy savings and is essential for heat pump performance. Community Partner
      Funding and CERTA funding remove barriers for income-qualified households. HEAR rebates provide up to $1,600 additional funding, and
      HOMES rebates reward whole-home performance improvements. Target poorly insulated homes for maximum impact.`,
    keyPoints: ["Best ROI per dollar", "Stackable funding (Energy Trust + CERTA + HEAR/HOMES)", "Prerequisite for HVAC efficiency"]
  },
  controls_and_thermostats: {
    title: "Smart Controls: Small Investment, Big Returns",
    content: `Smart thermostats cost under $250 but deliver 8–15% energy savings. They're perfect bundled with heat pumps to prevent
      inefficient auxiliary heat. Direct-install via Community Partner Funding removes upfront barriers.`,
    keyPoints: ["Low cost, high payback", "Behavior change enabler", "Enhances HVAC performance"]
  },
  windows: {
    title: "Windows: Comfort Over Savings",
    content: `Window replacements offer significant comfort improvements but limited financial payback. Prioritize for health drivers
      (condensation, noise) or in Community Partner Funding projects where co-funding covers costs. Always bundle with air-sealing.`,
    keyPoints: ["High comfort impact", "Long payback period", "Best for equity-driven projects"]
  },
  gas_heating_systems: {
    title: "Gas Systems: Safety & Transition",
    content: `Gas furnaces remain relevant for safety upgrades and homes not ready for electrification. Focus on AFUE ≥95% and proper 
      venting. Fireplace incentives have questionable value and may warrant reprioritization.`,
    keyPoints: ["Mature technology", "Safety compliance focus", "Consider electrification alternatives"]
  },
  water_heating_systems: {
    title: "Water Heating: The Electrification Partner",
    content: `Heat pump water heaters align with decarbonization goals and save on operating costs. CPF can cover full costs for priority
      households, and HEAR rebates add up to $1,750 for qualifying installations. Always verify electrical capacity and space requirements
      before installation.`,
    keyPoints: ["Supports electrification", "Stackable rebates (Energy Trust + HEAR)", "Best bundled with other upgrades"]
  },
  home_energy_assessment_and_certa: {
    title: "Assessments: Your Project Gateway",
    content: `Home energy assessments identify opportunities and prioritize multi-measure pathways. CERTA funding (up to $2,000) removes 
      repair barriers like outdated wiring or structural issues that block weatherization work.`,
    keyPoints: ["Identifies best opportunities", "Prioritizes multi-measure work", "CERTA enables stuck projects"]
  }
};

/** ---------- DATA (from your refined, practical JSON) ---------- **/
const DATA = {
  heat_pumps: {
    title: "Heat Pumps (ductless, ducted, extended-capacity)",
    summary: "Typically high-impact electrification; potential strong savings; tiered incentives may include federal HEAR rebates (verify availability).",
    impact_tags: ["High impact","Electrification"],
    cost_and_incentive_ratio: {
      average_cost_usd: "2500–15000",
      standard_incentive_usd: 800,
      coverage_percent: "16–37%",
      swr_cpf_coverage_percent: "36–100%",
      hear_rebate_usd: "Up to $8,000 (≤80% AMI) or $8,000 (≤150% AMI)"
    },
    equity_and_market_leverage: [
      "CPF & no-cost tiers may remove upfront barriers; HEAR rebates may stack for income-qualified households (verify current availability).",
      "Standard tier + HEAR rebates may respond to financing + insulation bundles (verify program terms)."
    ],
    implementation_priorities: [
      "Typical specs: HSPF2 ≥ 8.1; correct sizing; aux heat lockout ≤ 35°F (verify current requirements).",
      "QA/QC via trade-ally network; target resistance or FA electric homes (verify program participation)."
    ],
    stakeholder_value: {
      program_manager: [
        "Consider bundling with insulation to potentially maximize savings; coordinate possible HEAR rebate stacking (verify eligibility).",
        "Track adoption; consider on-bill financing options; educate on potential HOMES/HEAR opportunities (verify program status)."
      ],
      homeowner: [
        "May cut heating/cooling bills 30–50% (actual savings vary); potential to stack Energy Trust + HEAR rebates (verify availability).",
        "SWR may reduce cost; CPF may offer no-cost options; HEAR may add up to $8,000 for qualifying households (verify all before purchasing)."
      ],
      contractor: [
        "Pre-approval may be required for CPF; load calcs + photos typically needed; verify HEAR eligibility if applicable.",
        "Provide commissioning & homeowner maintenance guidance; coordinate federal and state rebate timing (verify current processes)."
      ]
    }
  },

  gas_heating_systems: {
    title: "Gas Heating Systems (furnaces & fireplaces)",
    summary: "Mature measure; useful for safety/compliance; lower energy impact.",
    impact_tags: ["Moderate impact","Combustion"],
    cost_and_incentive_ratio: {
      furnace_cost_usd: "3000–7500",
      furnace_incentive_usd: "1600–2900",
      coverage_percent: "32–58%",
      fireplace_cost_usd: "2000–5000",
      fireplace_incentive_usd: "150–250"
    },
    equity_and_market_leverage: [
      "Higher rental incentives improve equity reach.",
      "Fireplace incentives have low energy value; consider deprioritization."
    ],
    implementation_priorities: [
      "AFUE ≥ 95%; CO monitors; sealed combustion; proper venting.",
      "Coordinate gas utility eligibility."
    ],
    stakeholder_value: {
      program_manager: [
        "Focus funding on safety/rental stock; watch free-ridership.",
        "Shift fireplace funds to higher-savings measures if needed."
      ],
      homeowner: [
        "Reliable comfort; better for gas-dependent homes.",
        "Fireplaces are mostly aesthetic; long payback."
      ],
      contractor: [
        "Document AFUE, CO monitor, venting; code compliance.",
        "Provide commissioning reports to support rebates."
      ]
    }
  },

  water_heating_systems: {
    title: "Water Heating (heat-pump & tankless gas)",
    summary: "Moderate savings; best when bundled with electrification; HEAR rebates available for HPWH.",
    impact_tags: ["Medium impact","Hot water"],
    cost_and_incentive_ratio: {
      hpwh_cost_usd: "3600–6500",
      hpwh_incentive_usd: 240,
      tankless_cost_usd: "1200–3500",
      tankless_incentive_usd: 400,
      hear_hpwh_rebate_usd: "Up to $1,750 (income-qualified)"
    },
    equity_and_market_leverage: [
      "CPF can fully fund HPWH in priority communities; HEAR rebates stack for additional savings.",
      "HPWH aligns with decarbonization; tankless suits transition homes (no HEAR rebate)."
    ],
    implementation_priorities: [
      "Check electric capacity (30A), space, condensate for HPWH.",
      "Target end-of-life electric tanks; manage refrigerant + noise."
    ],
    stakeholder_value: {
      program_manager: [
        "Bundle HPWH with heat pump or panel upgrades for scale; coordinate HEAR rebate applications.",
        "Use CPF to overcome upfront barriers; promote federal rebate stacking."
      ],
      homeowner: [
        "Lower operating cost; quiet, efficient; stack Energy Trust + HEAR for up to $1,990 total rebates.",
        "CPF may eliminate upfront cost; HEAR rebate applied at point of sale for qualifying households."
      ],
      contractor: [
        "Pre-site checks (power, drain, airflow); verify HEAR eligibility and coordinate applications.",
        "Customer orientation on temp/filters; submit for both state and federal rebates."
      ]
    }
  },

  insulation_and_envelope: {
    title: "Insulation & Envelope (attic, wall, floor)",
    summary: "Highest $/savings; prerequisite for heat-pump performance; HEAR + HOMES rebates available.",
    impact_tags: ["Very high impact","Weatherization"],
    cost_and_incentive_ratio: {
      average_cost_per_sqft_usd: "1.0–4.5",
      standard_coverage: "50–60%",
      swr_cpf_coverage: "60–120%",
      certa_fund_usd: 2000,
      hear_insulation_rebate_usd: "Up to $1,600 (income-qualified)",
      homes_rebate_usd: "$2,000–$8,000 (whole-home performance)"
    },
    equity_and_market_leverage: [
      "CPF + CERTA remove structural barriers (wiring, rot, moisture); HEAR/HOMES rebates stack for maximum coverage.",
      "Link with health/IAQ funding to widen access; HOMES rewards comprehensive energy savings."
    ],
    implementation_priorities: [
      "Audit R-values; insulate to R-38 attic, R-30 floor (SF), R-22 (MH).",
      "Add air-sealing, ventilation; photo & sqft documentation."
    ],
    stakeholder_value: {
      program_manager: [
        "Target worst-insulated homes for highest returns; coordinate HEAR/HOMES rebate stacking for comprehensive projects.",
        "Use CERTA to unlock 'stuck' projects; promote whole-home approach for HOMES eligibility."
      ],
      homeowner: [
        "Comfort year-round; big bill savings; often $0 under CPF + HEAR stacking (up to $1,600 HEAR + standard incentives).",
        "SWR typically halves out-of-pocket cost; HOMES rebates reward comprehensive upgrades ($2,000-$8,000)."
      ],
      contractor: [
        "Address rim joists & knee walls; vapor details matter; document for HEAR/HOMES applications.",
        "Follow CERTA workflow for enabling repairs; coordinate energy modeling for HOMES rebates."
      ]
    }
  },

  windows: {
    title: "Windows",
    summary: "High comfort; low financial payback; equity-driven use case; limited federal rebate support.",
    impact_tags: ["Comfort","Low energy ROI"],
    cost_and_incentive_ratio: {
      avg_window_cost_usd: 600,
      incentive_per_sqft_usd: "1.0–1.5",
      coverage_percent: "2–3%",
      homes_contribution: "Contributes to whole-home savings (HOMES rebate)"
    },
    equity_and_market_leverage: [
      "CPF enhanced windows may cover full cost with co-funding; HOMES rebates reward as part of comprehensive upgrades.",
      "Prioritize single-pane / metal-framed double-pane homes; best ROI when bundled with insulation."
    ],
    implementation_priorities: [
      "Verify U-value tiers (≤0.22 or 0.23–0.27).",
      "Bundle with air-sealing; ensure flashing & drainage plane."
    ],
    stakeholder_value: {
      program_manager: [
        "Use selectively for health/condensation, noise, or safety drivers; bundle for HOMES eligibility.",
        "Favor CPF projects where co-funding exists; track contribution to whole-home savings."
      ],
      homeowner: [
        "Major comfort upgrade; less bill impact unless replacing single-pane; contributes to HOMES rebate when bundled.",
        "CPF may enable no-cost installs; part of comprehensive energy savings strategy."
      ],
      contractor: [
        "U-factor documentation; measure conditions correctly; include in HOMES energy modeling if applicable.",
        "Educate on ventilation to manage condensation; coordinate with other upgrades."
      ]
    }
  },

  controls_and_thermostats: {
    title: "Controls & Thermostats",
    summary: "Low-cost, high-payback; boosts HVAC performance; no direct federal rebate.",
    impact_tags: ["High ROI","Behavior + control"],
    cost_and_incentive_ratio: {
      device_cost_usd: "113–239",
      incentive_usd: 250,
      coverage_percent: "≈100%",
      federal_rebate: "None (not covered by HEAR/HOMES)"
    },
    equity_and_market_leverage: [
      "CPF direct-install enables instant comfort and savings; enhances performance of HEAR-eligible heat pumps.",
      "Pair with heat pumps to curb auxiliary heat; critical for optimizing federal rebate investments."
    ],
    implementation_priorities: [
      "Maintain approved model list & compatibility matrix.",
      "Set heat-pump lockout ≤ 35°F; verify Wi-Fi/app setup."
    ],
    stakeholder_value: {
      program_manager: [
        "Great uptake driver; keep funded as a bundle; educate on maximizing HEAR heat pump rebates.",
        "Track persistence with follow-up nudges; optimize federal rebate-eligible equipment performance."
      ],
      homeowner: [
        "8–15% energy reduction; better comfort & control; maximizes efficiency of HEAR-rebated heat pumps.",
        "Often free after incentive; essential for getting full value from federal investments."
      ],
      contractor: [
        "Fast install; strong add-on to HVAC quotes; recommend with all HEAR heat pump installations.",
        "Provide brief training for satisfaction; explain optimization of federal rebate equipment."
      ]
    }
  },

  home_energy_assessment_and_certa: {
    title: "Home Energy Assessment & CERTA",
    summary: "Gateway service; aligns projects and funding; critical for HOMES rebate qualification.",
    impact_tags: ["Enablement","Pipeline"],
    cost_and_incentive_ratio: {
      audit_cost_usd: "439–615",
      rebate_usd: "250–500",
      coverage_percent: "50–100%",
      certa_funding_usd: 2000,
      homes_requirement: "Energy modeling required for HOMES rebates"
    },
    equity_and_market_leverage: [
      "CERTA removes repair barriers (e.g., wiring, rot) enabling both state and federal rebate eligibility.",
      "Full audit coverage for CPF/multifamily expands equity; assessments required for HOMES rebate applications."
    ],
    implementation_priorities: [
      "Standardize report & digital submission.",
      "Integrate with project tracking & referrals."
    ],
    stakeholder_value: {
      program_manager: [
        "Use audits to prioritize multi-measure pathways and qualify for HOMES rebates ($2k-$8k).",
        "Coordinate cross-funders for stackable support (Energy Trust + CERTA + HEAR/HOMES)."
      ],
      homeowner: [
        "Clear roadmap of upgrades & rebates; assessment unlocks HOMES performance-based rebates.",
        "Repairs covered via CERTA can 'unlock' insulation and qualify for federal incentives."
      ],
      contractor: [
        "Certified only; ensure complete data capture for both state and HOMES rebate applications.",
        "Plan multifamily logistics and documentation; conduct energy modeling for HOMES eligibility."
      ]
    }
  }
};

/** ---------- UTILITIES ---------- **/
const byKey = (obj, key) => obj[key];
const fmtMoney = v => (typeof v === "number" ? `$${v.toLocaleString()}` : v);
const html = (strings, ...vals) => strings.map((s,i)=>s+(vals[i]??"")).join("");

const PROJECT_OPTIONS = Object.entries(DATA).map(([k,v])=>({value:k,label:v.title}));
const AUDIENCE_OPTIONS = [
  {value:"program_manager",label:"Program Manager"},
  {value:"homeowner",label:"Homeowner"},
  {value:"contractor",label:"Contractor"}
];

/** ---------- STATE ---------- **/
let selectedProjects = new Set();
let selectedAudiences = new Set(["program_manager","homeowner","contractor"]);
let currentTheme = localStorage.getItem("theme") || "dark";

/** ---------- ELEMENTS ---------- **/
const cardsEl = document.getElementById("cards");
const qEl = document.getElementById("q");
const msgEl = document.getElementById("msg");
const contextBoxEl = document.getElementById("contextBox");
const themeToggleBtn = document.getElementById("themeToggle");
const themeIconEl = document.getElementById("themeIcon");
const themeLabelEl = document.getElementById("themeLabel");
const headerEl = document.querySelector("header");
const headerTitleEl = document.getElementById("headerTitle");
const filterSummaryEl = document.getElementById("filterSummary");

/** ---------- THEME ---------- **/
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  currentTheme = theme;
  localStorage.setItem("theme", theme);
  if(theme==="light"){
    themeIconEl.textContent = "🌙";
    themeLabelEl.textContent = "Dark";
  } else {
    themeIconEl.textContent = "☀️";
    themeLabelEl.textContent = "Light";
  }
}

function toggleTheme(){
  applyTheme(currentTheme==="dark" ? "light" : "dark");
}

/** ---------- HEADER COLLAPSE ---------- **/
function toggleHeader(){
  const isCollapsed = headerEl.classList.toggle("collapsed");
  headerTitleEl.setAttribute("aria-expanded", !isCollapsed);
  updateFilterSummary();
}

function updateFilterSummary(){
  if(!headerEl.classList.contains("collapsed")) return;

  const parts = [];

  // Add project count
  if(selectedProjects.size > 0){
    parts.push(`${selectedProjects.size} project${selectedProjects.size===1?'':'s'}`);
  } else {
    parts.push("All projects");
  }

  // Add audience count
  const audCount = selectedAudiences.size;
  if(audCount < 3){
    const audNames = Array.from(selectedAudiences).map(a=>AUDIENCE_OPTIONS.find(o=>o.value===a)?.label).join(", ");
    parts.push(audNames);
  } else {
    parts.push("All audiences");
  }

  // Add search if present
  const search = qEl.value.trim();
  if(search){
    parts.push(`"${search}"`);
  }

  filterSummaryEl.textContent = parts.join(" · ");
}

/** ---------- RECOMMENDATIONS ROLLUP ---------- **/
function renderRecommendations(){
  const recommendationsEl = document.getElementById("recommendations");
  if(!recommendationsEl) return;

  if(selectedProjects.size === 0){
    recommendationsEl.style.display = "none";
    return;
  }

  // Gather data from selected projects
  const selectedData = Array.from(selectedProjects).map(key=>DATA[key]);

  // Count high-impact projects
  const highImpact = selectedData.filter(d=>d.impact_tags?.some(t=>t.includes("High") || t.includes("Very high"))).length;

  // Check for stackable funding opportunities
  const hasStacking = selectedData.some(d=>
    d.equity_and_market_leverage?.some(e=>e.toLowerCase().includes("stack")) ||
    d.stakeholder_value?.homeowner?.some(h=>h.toLowerCase().includes("stack"))
  );

  // Get funding sources mentioned
  const fundingSources = new Set();
  selectedData.forEach(d=>{
    const text = JSON.stringify(d).toLowerCase();
    if(text.includes("swr") || text.includes("savings within reach")) fundingSources.add("SWR");
    if(text.includes("cpf") || text.includes("community partner")) fundingSources.add("CPF");
    if(text.includes("certa")) fundingSources.add("CERTA");
    if(text.includes("hear")) fundingSources.add("HEAR");
    if(text.includes("homes")) fundingSources.add("HOMES");
  });

  // Build recommendations
  const recs = [];

  if(highImpact > 0){
    recs.push(`${highImpact} high-impact project${highImpact>1?'s':''} selected with significant energy savings potential`);
  }

  if(hasStacking && fundingSources.size > 1){
    recs.push(`Multiple funding sources available: ${Array.from(fundingSources).join(", ")} - consider stacking for maximum savings`);
  }

  if(selectedProjects.has("insulation_and_envelope") && selectedProjects.has("heat_pumps")){
    recs.push(`Excellent pairing: Insulation + heat pumps delivers optimal performance and energy savings`);
  }

  if(fundingSources.has("HEAR") || fundingSources.has("HOMES")){
    recs.push(`Federal IRA rebates may be available - verify Oregon implementation status with state energy office`);
  }

  if(selectedAudiences.has("homeowner") && !selectedAudiences.has("contractor")){
    recs.push(`Consider consulting certified contractors for accurate quotes and installation guidance`);
  }

  if(recs.length === 0){
    recommendationsEl.style.display = "none";
    return;
  }

  recommendationsEl.innerHTML = `
    <h2>💡 Key Recommendations</h2>
    <ul>${recs.map(r=>`<li>${r}</li>`).join("")}</ul>
  `;
  recommendationsEl.style.display = "block";
}

/** ---------- CONTEXT BOX ---------- **/
function renderContext(){
  if(selectedProjects.size === 0){
    const ctx = OVERVIEW_CONTEXT.default;
    contextBoxEl.innerHTML = `
      <h2>${ctx.title}</h2>
      <p>${ctx.content}</p>
    `;
    contextBoxEl.style.display = "block";
  } else if(selectedProjects.size === 1){
    const key = Array.from(selectedProjects)[0];
    const ctx = OVERVIEW_CONTEXT[key] || OVERVIEW_CONTEXT.default;
    const points = ctx.keyPoints ? `<ul>${ctx.keyPoints.map(p=>`<li>${p}</li>`).join("")}</ul>` : "";
    contextBoxEl.innerHTML = `
      <h2>${ctx.title}</h2>
      <p>${ctx.content}</p>
      ${points}
    `;
    contextBoxEl.style.display = "block";
  } else {
    contextBoxEl.style.display = "none";
  }
}

/** ---------- INIT FILTERS ---------- **/
function initFilters(){
  const projectFiltersEl = document.getElementById("projectFilters");
  const audienceFiltersEl = document.getElementById("audienceFilters");
  
  // Project checkboxes
  PROJECT_OPTIONS.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "checkbox-item";
    const id = `proj_${opt.value}`;
    div.innerHTML = `<input type="checkbox" id="${id}" value="${opt.value}"/><label for="${id}">${opt.label}</label>`;
    projectFiltersEl.appendChild(div);
    const cb = div.querySelector("input");
    cb.addEventListener("change", ()=>{
      if(cb.checked) selectedProjects.add(opt.value);
      else selectedProjects.delete(opt.value);
      renderAll();
    });
  });
  
  // Audience checkboxes
  AUDIENCE_OPTIONS.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "checkbox-item";
    const id = `aud_${opt.value}`;
    div.innerHTML = `<input type="checkbox" id="${id}" value="${opt.value}" checked/><label for="${id}">${opt.label}</label>`;
    audienceFiltersEl.appendChild(div);
    const cb = div.querySelector("input");
    cb.addEventListener("change", ()=>{
      if(cb.checked) selectedAudiences.add(opt.value);
      else selectedAudiences.delete(opt.value);
      renderAll();
    });
  });
}

function badgeDots(key){
  const map = {
    "High impact":"good","Very high impact":"good","High ROI":"good",
    "Comfort":"warn","Low energy ROI":"warn","Combustion":"danger"
  };
  return map[key]||"warn";
}

function renderCards(){
  const query = qEl.value.trim().toLowerCase();

  // build list
  let items = Object.entries(DATA).map(([k,v])=>({key:k, ...v}));

  // filter by selected projects
  if(selectedProjects.size > 0){
    items = items.filter(i=>selectedProjects.has(i.key));
  }

  // search query across title, summary, tags and audience text
  if(query){
    items = items.filter(i=>{
      const hay = [
        i.title, i.summary, ...(i.impact_tags||[]),
        ...(i.equity_and_market_leverage||[]),
        ...(i.implementation_priorities||[]),
        ...((i.stakeholder_value?.program_manager)||[]),
        ...((i.stakeholder_value?.homeowner)||[]),
        ...((i.stakeholder_value?.contractor)||[])
      ].join(" ").toLowerCase();
      return hay.includes(query);
    });
  }

  cardsEl.innerHTML = "";

  items.forEach(item=>{
    const {title, summary, impact_tags=[], cost_and_incentive_ratio={}, equity_and_market_leverage=[], implementation_priorities=[]} = item;

    // Filter cost/incentive data based on audience
    const getRelevantCostData = (data) => {
      const entries = Object.entries(data);

      // If all audiences selected or none, show everything
      if(selectedAudiences.size === 3 || selectedAudiences.size === 0) return entries;

      // Define what each audience cares about
      const audienceRelevance = {
        homeowner: ['average_cost', 'cost', 'incentive', 'rebate', 'coverage', 'swr', 'cpf', 'hear', 'homes'],
        contractor: ['average_cost', 'cost', 'incentive', 'rebate', 'coverage', 'swr', 'cpf', 'hear', 'homes', 'requirement'],
        program_manager: ['average_cost', 'cost', 'incentive', 'rebate', 'coverage', 'swr', 'cpf', 'certa', 'hear', 'homes', 'fund']
      };

      // Filter based on selected audiences
      return entries.filter(([key]) => {
        const lowerKey = key.toLowerCase();
        return Array.from(selectedAudiences).some(aud =>
          audienceRelevance[aud].some(term => lowerKey.includes(term))
        );
      });
    };

    const costPills = getRelevantCostData(cost_and_incentive_ratio).map(([k,v])=>{
      // Create readable labels with proper capitalization
      let label = k.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase());
      // Fix acronyms
      label = label.replace(/\bSwr\b/g, "SWR").replace(/\bCpf\b/g, "CPF")
                   .replace(/\bHpwh\b/g, "HPWH").replace(/\bHear\b/g, "HEAR")
                   .replace(/\bHomes\b/g, "HOMES").replace(/\bUsd\b/g, "USD");
      return `<span class="pill" title="${label} (Approximate - Verify Current Amounts)">${label}: ${typeof v==='object'?JSON.stringify(v):fmtMoney(v)}</span>`;
    }).join("");
    const costDisclaimer = costPills ? `<p style="font-size:11px;color:var(--muted);margin:6px 0 0 0;"><em>⚠️ Approximate costs/incentives - verify current amounts with program administrators before purchasing</em></p>` : '';

    const tags = impact_tags.map(t=>`<span class="chip"><span class="dot ${badgeDots(t)}"></span>${t}</span>`).join("");

    // audience blocks
    const showPM = selectedAudiences.has("program_manager");
    const showHO = selectedAudiences.has("homeowner");
    const showCT = selectedAudiences.has("contractor");

    const pm = (item.stakeholder_value?.program_manager||[]).map(li=>`<li>${li}</li>`).join("") || "<li class='muted'>No items</li>";
    const ho = (item.stakeholder_value?.homeowner||[]).map(li=>`<li>${li}</li>`).join("") || "<li class='muted'>No items</li>";
    const ct = (item.stakeholder_value?.contractor||[]).map(li=>`<li>${li}</li>`).join("") || "<li class='muted'>No items</li>";

    // Filter equity & market leverage based on audience
    // Green tags: show for HOMEOWNER or PROGRAM MANAGER
    const showEquity = selectedAudiences.has("homeowner") || selectedAudiences.has("program_manager");
    const eq = showEquity ? (equity_and_market_leverage||[]).map(x=>`<span class="tag green">${x}</span>`).join("") : "";

    // Filter implementation priorities based on audience
    // Blue tags: show for CONTRACTOR or PROGRAM MANAGER
    const showImpl = selectedAudiences.has("contractor") || selectedAudiences.has("program_manager");
    const impl = showImpl ? (implementation_priorities||[]).map(x=>`<span class="tag blue">${x}</span>`).join("") : "";

    const card = document.createElement("section");
    card.className = "card";
    card.dataset.key = item.key;

    card.innerHTML = html`
      <h3>${title}</h3>
      <div class="muted">${summary}</div>
      <div class="row" style="margin-top:8px">${tags}</div>

      ${costPills ? `<div class="kv">${costPills}</div>` : ''}
      ${costDisclaimer}

      ${eq ? `<div class="row">${eq}</div>` : ''}
      ${eq && impl ? `<div style="height:6px"></div>` : ''}
      ${impl ? `<div class="row">${impl}</div>` : ''}

      <div class="sep"></div>

      <div class="aud-block">
        ${showPM ? `<div class="aud"><h4>Program Manager</h4><ul>${pm}</ul></div>` : ``}
        ${showHO ? `<div class="aud"><h4>Homeowner</h4><ul>${ho}</ul></div>` : ``}
        ${showCT ? `<div class="aud"><h4>Contractor</h4><ul>${ct}</ul></div>` : ``}
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btnCopyCard">Copy Card</button>
        <button class="btnJson">View JSON</button>
      </div>
    `;

    // button handlers
    card.querySelector(".btnCopyCard").onclick = ()=>{
      const text = card.innerText.replace(/\n{2,}/g,"\n").trim();
      navigator.clipboard.writeText(text);
      flash("Copied card text");
    };
    card.querySelector(".btnJson").onclick = ()=>{
      const pretty = JSON.stringify(DATA[item.key], null, 2);
      const blob = new Blob([pretty], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `${item.key}.json`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    };

    cardsEl.appendChild(card);
  });

  if(items.length===0){
    const empty = document.createElement("div");
    empty.className="card";
    empty.innerHTML = `<div class="muted">No results. Try selecting different filters or using broader keywords.</div>`;
    cardsEl.appendChild(empty);
  }
}

function renderAll(){
  renderContext();
  renderRecommendations();
  renderCards();
  updateFilterSummary();
}

function flash(text){
  msgEl.textContent = text;
  msgEl.classList.remove("hide");
  setTimeout(()=>msgEl.classList.add("hide"), 1800);
}

function exportVisibleJSON(){
  const q = qEl.value.trim().toLowerCase();
  let items = Object.entries(DATA).map(([k,v])=>({k,v}));
  
  if(selectedProjects.size > 0){
    items = items.filter(({k})=>selectedProjects.has(k));
  }
  
  if(q){
    items = items.filter(({v})=>{
      const hay = [
        v.title, v.summary, ...(v.impact_tags||[]),
        ...(v.equity_and_market_leverage||[]),
        ...(v.implementation_priorities||[]),
        ...((v.stakeholder_value?.program_manager)||[]),
        ...((v.stakeholder_value?.homeowner)||[]),
        ...((v.stakeholder_value?.contractor)||[])
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }
  
  // Filter by selected audiences
  const pruned = {};
  items.forEach(({k,v})=>{
    const copy = JSON.parse(JSON.stringify(v));
    if(selectedAudiences.size < 3){
      const filteredValue = {};
      selectedAudiences.forEach(aud => {
        filteredValue[aud] = v.stakeholder_value?.[aud] || [];
      });
      copy.stakeholder_value = filteredValue;
    }
    pruned[k]=copy;
  });
  
  const blob = new Blob([JSON.stringify(pruned,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="visible_insights.json"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1500);
  flash("Exported JSON");
}

// Button listeners
document.getElementById("btnCopy").onclick = ()=>{
  const t = Array.from(document.querySelectorAll(".card")).map(c=>c.innerText).join("\n\n---\n\n");
  navigator.clipboard.writeText(t); flash("Copied visible insights");
};
document.getElementById("btnExport").onclick = exportVisibleJSON;
themeToggleBtn.onclick = toggleTheme;
headerTitleEl.onclick = toggleHeader;

// Keyboard accessibility for header toggle
headerTitleEl.addEventListener("keydown", (e)=>{
  if(e.key === "Enter" || e.key === " "){
    e.preventDefault();
    toggleHeader();
  }
});

// Skip link functionality
document.querySelector(".skip-link").addEventListener("focus", function(){
  this.style.left = "0";
});
document.querySelector(".skip-link").addEventListener("blur", function(){
  this.style.left = "-9999px";
});

qEl.addEventListener("input", ()=>{
  renderCards();
  updateFilterSummary();
});

// init
applyTheme(currentTheme);
initFilters();
renderAll();
</script>
</body>
</html>
